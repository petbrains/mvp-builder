# MVP Builder Installer for Windows PowerShell
# Usage: irm https://raw.githubusercontent.com/petbrains/mvp-builder/main/scripts/install.ps1 | iex

$ErrorActionPreference = "Stop"

$REPO = "petbrains/mvp-builder"
$FILES_TO_COPY = @(".claude", "CLAUDE.md", ".mcp.json")
$USER_AGENT = "mvp-builder"
$HEADERS = @{ "User-Agent" = $USER_AGENT }

Write-Host ""
Write-Host "üöÄ MVP Builder Installer" -ForegroundColor Cyan
Write-Host ""

# Get latest release or fallback to main
function Get-DownloadUrl {
    try {
        # FIX: Added User-Agent header
        $releaseInfo = Invoke-RestMethod -Uri "https://api.github.com/repos/$REPO/releases/latest" `
            -Headers $HEADERS -UseBasicParsing -ErrorAction SilentlyContinue
        if ($releaseInfo.zipball_url) {
            $script:VERSION = $releaseInfo.tag_name
            $script:DOWNLOAD_URL = $releaseInfo.zipball_url
            Write-Host "üì¶ Installing $VERSION..." -ForegroundColor Cyan
            return
        }
    } catch {
        # Fallback to main
    }
    
    # Fallback to main branch
    $script:VERSION = "main"
    $script:DOWNLOAD_URL = "https://github.com/$REPO/archive/refs/heads/main.zip"
    Write-Host "üì¶ Installing from main branch..." -ForegroundColor Cyan
}

Get-DownloadUrl

# Check for existing files
$existing = @()
foreach ($file in $FILES_TO_COPY) {
    if (Test-Path $file) {
        $existing += $file
    }
}

if ($existing.Count -gt 0) {
    Write-Host ""
    Write-Host "‚ö†Ô∏è  Found existing files: $($existing -join ', ')" -ForegroundColor Yellow
    Write-Host ""
    
    # FIX: Check if running interactively
    if ([Environment]::UserInteractive -and [Console]::KeyAvailable -ne $null) {
        $response = Read-Host "Overwrite? (y/N)"
        if ($response -notmatch "^[Yy]$") {
            Write-Host "Cancelled."
            exit 1
        }
    } else {
        # Non-interactive: require -Force parameter or fail safe
        Write-Host "‚ùå Existing files found. Run interactively or remove existing files first." -ForegroundColor Red
        exit 1
    }
}

# Create temp directory
$tempDir = Join-Path $env:TEMP "mvp-builder-install-$(Get-Random)"
New-Item -ItemType Directory -Path $tempDir -Force | Out-Null

try {
    # Download
    $zipPath = Join-Path $tempDir "repo.zip"
    # FIX: Added User-Agent header
    Invoke-WebRequest -Uri $DOWNLOAD_URL -OutFile $zipPath -Headers $HEADERS -UseBasicParsing

    # Extract
    Write-Host "üìÇ Extracting..." -ForegroundColor Cyan
    Expand-Archive -Path $zipPath -DestinationPath $tempDir -Force

    # Find extracted folder (FIX: removed specific filter)
    $extractedDir = Get-ChildItem -Path $tempDir -Directory | 
        Where-Object { $_.Name -ne "repo.zip" } | 
        Select-Object -First 1

    if (-not $extractedDir) {
        throw "Could not find extracted directory"
    }

    # Copy files
    Write-Host "üìã Copying files..." -ForegroundColor Cyan
    foreach ($file in $FILES_TO_COPY) {
        $sourcePath = Join-Path $extractedDir.FullName $file
        if (Test-Path $sourcePath) {
            if (Test-Path $file) {
                Remove-Item $file -Recurse -Force
            }
            Copy-Item $sourcePath -Destination . -Recurse -Force
            Write-Host "   ‚úì $file" -ForegroundColor Green
        } else {
            Write-Host "   ‚ö† $file not found in repository" -ForegroundColor Yellow
        }
    }

    Write-Host ""
    Write-Host "‚úÖ MVP Builder installed! ($VERSION)" -ForegroundColor Green
    Write-Host ""
    Write-Host "Next steps:"
    Write-Host "   1. Run /docs:prd to define your product"
    Write-Host "   2. Run /docs:feature to generate specifications"
    Write-Host ""

} finally {
    # Cleanup
    if (Test-Path $tempDir) {
        Remove-Item $tempDir -Recurse -Force -ErrorAction SilentlyContinue
    }
}